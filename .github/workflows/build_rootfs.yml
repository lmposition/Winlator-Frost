name: Build GStmangohudRootFS for Winlator

permissions:
  contents: write

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'build-rootfs2.sh'
      - 'arch-bootstrap.sh'
      - 'data.tar.xz'
      - 'tzdata-*.pkg.tar.xz'
      - '.github/workflows/build_rootfs.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'build-rootfs2.sh'
      - 'arch-bootstrap.sh'
      - 'data.tar.xz'
      - 'tzdata-*.pkg.tar.xz'
      - '.github/workflows/build_rootfs.yml'
  workflow_dispatch:
    inputs:
      inputGstVersion:
        description: "GStreamer version"
        required: true
        default: "1.27.2"
      inputXzVersion:
        description: "XZ version"
        required: true
        default: "v5.8.1"
      inputLibxkbcommonVersion:
        description: "libxkbcommon version"
        required: true
        default: "xkbcommon-1.7.0"
      inputMangoHudVersion:
        description: "MangoHud version"
        required: true
        default: "v0.7.1"
      inputCustomTag:
        description: "Custom tag name"
        required: true
        default: "beta11-g2.39"

env:
  gstVer: ${{ github.event.inputs.inputGstVersion || '1.27.2' }}
  xzVer: ${{ github.event.inputs.inputXzVersion || 'v5.8.1' }}
  libxkbcommonVer: ${{ github.event.inputs.inputLibxkbcommonVersion || 'xkbcommon-1.7.0' }}
  mangohudVer: ${{ github.event.inputs.inputMangoHudVersion || 'v0.7.1' }}
  customTag: ${{ github.event.inputs.inputCustomTag || 'beta11-g2.39' }}

jobs:
  build-rootfs2:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            arch-bootstrap.sh
            build-rootfs2.sh
            data.tar.xz
            tzdata-2025b-1-aarch64.pkg.tar.xz

      - name: Setup chroot environment
        run: |
          sudo apt update
          sudo apt install -y coreutils curl sed gawk tar gzip xz-utils zstd patchelf
          
          chmod +x arch-bootstrap.sh
          sudo cp arch-bootstrap.sh /usr/local/bin/arch-bootstrap
          
          cd /tmp
          sudo arch-bootstrap -a aarch64 archlinux

      - name: Install build dependencies in chroot
        run: |
          cat > /tmp/install-deps.sh << 'EOF'
          #!/bin/bash
          pacman -Syu --noconfirm
          pacman-key --init
          pacman -S --noconfirm --needed \
            base-devel \
            ninja \
            meson \
            git \
            glib2-devel \
            libx11 \
            mesa \
            libpulse \
            vulkan-devel \
            nasm \
            yasm \
            glslang \
            cmake \
            patchelf \
            libde265 \
            wget \
            ca-certificates \
            libdrm \
            dbus \
            python3 \
            python-mako \
            glm \
            nlohmann-json \
            libxcb \
            xorgproto \
            wayland \
            wayland-protocols \
            libglvnd \
            libxrandr \
            libxinerama \
            libxdamage \
            libxfixes
          exit 0
          EOF
          
          sudo chmod +x /tmp/install-deps.sh
          sudo cp /tmp/install-deps.sh /tmp/archlinux/
          
          sudo mount --bind /proc /tmp/archlinux/proc
          sudo mount --bind /sys /tmp/archlinux/sys
          sudo mount --bind /dev /tmp/archlinux/dev
          
          sudo chroot /tmp/archlinux /install-deps.sh
          
          sudo rm /tmp/archlinux/install-deps.sh

      - name: Prepare build files in chroot
        run: |
          sudo cp build-rootfs2.sh /tmp/archlinux/tmp/
          sudo cp data.tar.xz /tmp/archlinux/tmp/
          sudo cp tzdata-2025b-1-aarch64.pkg.tar.xz /tmp/archlinux/tmp/
          
          cat > /tmp/init.sh << EOF
          export gstVer=$gstVer
          export xzVer=$xzVer
          export libxkbcommonVer=$libxkbcommonVer
          export mangohudVer=$mangohudVer
          export customTag=$customTag
          EOF
          
          sudo cp /tmp/init.sh /tmp/archlinux/tmp/
          sudo chmod +x /tmp/archlinux/tmp/build-rootfs2.sh

      - name: Build rootfs with GStreamer, libxkbcommon and MangoHud
        run: |
          set -e
          if ! sudo chroot /tmp/archlinux /tmp/build-rootfs2.sh; then
            echo "Build failed, cleaning up..."
            sudo umount -l /tmp/archlinux/dev || true
            sudo umount -l /tmp/archlinux/sys || true
            sudo umount -l /tmp/archlinux/proc || true
            exit 1
          fi
          
          sudo umount -l /tmp/archlinux/dev || true
          sudo umount -l /tmp/archlinux/sys || true
          sudo umount -l /tmp/archlinux/proc || true

      - name: Upload RootFS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rootfs-${{ env.customTag }}
          path: |
            /tmp/archlinux/tmp/output/output-lite.tar.xz
            /tmp/archlinux/tmp/output/output-full.tar.xz
            /tmp/archlinux/tmp/output/rootfs.tzst

      - name: Create build summary
        if: success()
        run: |
          echo "## ðŸ—‚ï¸ RootFS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **GStreamer Version**: ${{ env.gstVer }}" >> $GITHUB_STEP_SUMMARY
          echo "- **XZ Version**: ${{ env.xzVer }}" >> $GITHUB_STEP_SUMMARY
          echo "- **libxkbcommon Version**: ${{ env.libxkbcommonVer }}" >> $GITHUB_STEP_SUMMARY
          echo "- **MangoHud Version**: ${{ env.mangohudVer }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Custom Tag**: ${{ env.customTag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          sudo rm -rf /tmp/archlinux
